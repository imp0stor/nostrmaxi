generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User accounts - linked to Nostr pubkeys
model User {
  id        String   @id @default(cuid())
  pubkey    String   @unique // hex pubkey
  npub      String   @unique // bech32 npub
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  nip05s            Nip05[]
  subscription      Subscription?
  sessions          Session[]
  apiKeys           ApiKey[]
  lnurlSessions     LnurlSession[]
  profileSettings   ProfileSettings?
  marketplaceSales   MarketplaceTransaction[] @relation("MarketplaceSeller")
  marketplaceBuys    MarketplaceTransaction[] @relation("MarketplaceBuyer")
  feeds              Feed[]
  feedSubscriptions  FeedSubscription[]
  domains            Domain[]
  sites              Site[]

  lightningAddress String?

  @@index([pubkey])
  @@index([lightningAddress])
}

model ProfileSettings {
  id         String   @id @default(uuid())
  userPubkey String   @unique
  user       User?    @relation(fields: [userPubkey], references: [pubkey], onDelete: Cascade)
  theme      String   @default("dark")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([theme])
}

model Endorsement {
  id             String   @id @default(uuid())
  endorserPubkey String
  endorseePubkey String
  skill          String
  createdAt      DateTime @default(now())

  @@unique([endorserPubkey, endorseePubkey, skill])
  @@index([endorseePubkey])
}

// User sessions (JWT-based)
model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token     String   @unique
  userAgent String?
  ipAddress String?
  
  expiresAt DateTime
  createdAt DateTime @default(now())
  lastUsedAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// Auth challenges for signature verification
model AuthChallenge {
  id        String   @id @default(cuid())
  challenge String   @unique
  pubkey    String?  // Optional: lock challenge to specific pubkey
  
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([challenge])
  @@index([expiresAt])
}

// LNURL-auth sessions
model LnurlSession {
  id        String   @id @default(cuid())
  k1        String   @unique // Challenge secret
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  linkingKey String?  // The linking pubkey from wallet
  status    String   @default("pending") // pending, verified, expired
  
  expiresAt DateTime
  verifiedAt DateTime?
  createdAt DateTime @default(now())

  @@index([k1])
  @@index([status])
}

// API Keys for Business tier
model ApiKey {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name      String
  keyHash   String   @unique // Hashed API key
  keyPrefix String   // First 8 chars for display (nm_xxxx...)
  
  permissions String[] @default(["read"]) // read, write, admin
  rateLimit Int      @default(1000) // requests per hour
  
  lastUsedAt DateTime?
  expiresAt  DateTime?
  revokedAt  DateTime?
  createdAt  DateTime @default(now())

  // Usage tracking
  usageLogs ApiKeyUsage[]

  @@index([keyHash])
  @@index([userId])
}

// API Key usage tracking
model ApiKeyUsage {
  id        String   @id @default(cuid())
  apiKeyId  String
  apiKey    ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  
  endpoint  String
  method    String
  statusCode Int
  
  createdAt DateTime @default(now())

  @@index([apiKeyId])
  @@index([createdAt])
}

// NIP-05 identities (user@domain.com)
model Nip05 {
  id        String   @id @default(cuid())
  localPart String   // "user" part of user@domain.com
  domain    String   // Domain for the NIP-05
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([localPart, domain])
  @@index([domain])
  @@index([userId])
  @@index([paymentId])
}

// Custom domains for NIP-05 + BYOD management
model Domain {
  id            String   @id @default(cuid())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  domain        String   @unique
  verified      Boolean  @default(false)
  verifyToken   String?  @unique // TXT record token for verification
  ownerPubkey   String   // Hex pubkey of owner
  lightningName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  site Site?

  @@index([ownerPubkey])
  @@index([userId])
}

model Site {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  domainId  String   @unique
  domain    Domain   @relation(fields: [domainId], references: [id], onDelete: Cascade)
  template  String   @default("personal")
  config    Json     @default("{}")
  views     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// User subscriptions
model Subscription {
  id        String  @id @default(cuid())
  userId    String  @unique
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier      String  @default("FREE") // FREE, PRO, BUSINESS, LIFETIME
  
  // Billing
  priceUsd     Int?      // Monthly price in cents
  priceSats    Int?      // Monthly price in sats
  
  // Lifecycle
  startsAt     DateTime  @default(now())
  expiresAt    DateTime?
  cancelledAt  DateTime?
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  payments     Payment[]

  @@index([tier])
  @@index([expiresAt])
}

// Payment records
model Payment {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  nip05s         Nip05[]
  
  amountSats     Int?
  amountUsd      Int?         // cents
  method         String       // "lightning" or "stripe"

  // Provider info (BTCPay, LNbits, etc.)
  provider         String?
  providerInvoiceId String?
  providerPaymentId String?
  
  // Lightning specific
  invoice        String?      // BOLT11 invoice
  paymentHash    String?      @unique
  lnbitsPaymentId String?     @unique
  
  // Stripe specific
  stripeId       String?      @unique
  
  status         String       @default("pending") // pending, paid, failed, expired
  paidAt         DateTime?
  
  // Receipt info
  receiptNumber  String?      @unique
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([status])
  @@index([subscriptionId])
  @@index([paymentHash])
  @@index([lnbitsPaymentId])
  @@index([provider, providerInvoiceId])
  @@index([providerPaymentId])
}

// Admin audit log
model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String?
  actorPubkey String?
  details   Json?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([createdAt])
}

model Config {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  type        String
  category    String
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@index([category])
}

model ReservedName {
  id        String   @id @default(uuid())
  name      String   @unique
  reason    String?
  createdAt DateTime @default(now())
}

model PremiumName {
  id           String   @id @default(uuid())
  name         String   @unique
  minimumPrice Int?
  reason       String?
  createdAt    DateTime @default(now())
}

model Nip05Auction {
  id                String    @id @default(uuid())
  name              String
  domain            String    @default("nostrmaxi.com")
  ownerPubkey       String?
  startsAt          DateTime
  endsAt            DateTime
  startingBidSats   Int
  reservePriceSats  Int?
  minIncrementSats  Int       @default(1000)
  currentBidSats    Int?
  currentBidderPubkey String?
  winnerPubkey      String?
  winningBidSats    Int?
  bidCount          Int       @default(0)
  status            String    @default("scheduled") // scheduled, live, ended, settlement_pending, settled, cancelled
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  bids Nip05Bid[]

  @@index([name, status])
  @@index([endsAt])
}

model Nip05Bid {
  id          String    @id @default(uuid())
  auctionId   String
  bidderPubkey String
  amountSats  Int
  status      String    @default("valid") // valid, refunded, rejected
  createdAt   DateTime  @default(now())

  auction Nip05Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@index([auctionId, amountSats(sort: Desc)])
  @@index([bidderPubkey])
}

model Nip05Listing {
  id            String    @id @default(uuid())
  name          String
  domain        String    @default("nostrmaxi.com")
  listingType   String    // flat, resale
  sellerPubkey  String
  fixedPriceSats Int?
  saleMode      String    @default("lifetime") // lifetime, lease_remainder
  leaseEndsAt   DateTime?
  status        String    @default("active") // active, pending_sale, sold, cancelled, expired
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([listingType, status])
  @@index([name])
  @@index([sellerPubkey])
}

model Nip05Transfer {
  id               String    @id @default(uuid())
  sourceType       String    // auction, listing
  sourceId         String
  buyerPubkey      String
  sellerPubkey     String?
  amountSats       Int
  platformFeeSats  Int
  sellerPayoutSats Int
  escrowStatus     String    @default("awaiting_payment") // awaiting_payment, funded, released, refunded
  transferStatus   String    @default("initiated") // initiated, payment_confirmed, ownership_transferred, completed, failed
  note             String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  completedAt      DateTime?

  @@index([buyerPubkey])
  @@index([sellerPubkey])
  @@index([sourceType, sourceId])
  @@index([escrowStatus, transferStatus])
}

model MarketplaceTransaction {
  id                 String   @id @default(uuid())
  sourceType         String   // listing, auction
  sourceId           String
  buyerPubkey        String
  sellerPubkey       String
  buyerId            String?
  sellerId           String?
  buyer              User?    @relation("MarketplaceBuyer", fields: [buyerId], references: [id], onDelete: SetNull)
  seller             User?    @relation("MarketplaceSeller", fields: [sellerId], references: [id], onDelete: SetNull)
  totalSats          Int
  feeBps             Int      @default(500)
  platformFeeSats    Int
  sellerPayoutSats   Int
  status             String   @default("pending") // pending, paid, failed, settled
  sellerPayoutStatus String   @default("pending") // pending, sent, confirmed, failed
  paymentProvider    String?
  paymentId          String?  @unique
  paymentHash        String?  @unique
  providerInvoiceId  String?  @unique
  sellerPayoutId     String?
  transferId         String?
  paidAt             DateTime?
  settledAt          DateTime?
  metadata           Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([sourceType, sourceId])
  @@index([buyerPubkey])
  @@index([sellerPubkey])
  @@index([status, sellerPayoutStatus])
}

model BlockedName {
  id        String   @id @default(uuid())
  name      String   @unique
  reason    String?
  createdAt DateTime @default(now())
}

model AdminAuditLog {
  id        String   @id @default(uuid())
  adminId   String
  action    String
  targetId  String?
  details   Json?
  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

model RelaySyncState {
  id             String   @id @default(cuid())
  pubkey         String   @unique
  priority       Int      @default(0)
  lastActive     DateTime?
  followerCount  Int      @default(0)
  lastSyncedAt   DateTime?
  syncStatus     String   @default("pending")
  eventsImported Int      @default(0)

  @@index([priority(sort: Desc)])
  @@index([syncStatus])
}

model RelaySyncStats {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  profilesSynced  Int
  notesSynced     Int
  reactionsSynced Int
  zapsSynced      Int
  totalEvents     Int
  errors          Int

  @@index([createdAt])
}

model DiscoveredRelay {
  id           String   @id @default(cuid())
  url          String   @unique
  firstSeenAt  DateTime @default(now())
  lastQueryAt  DateTime?
  successCount Int      @default(0)
  failureCount Int      @default(0)
  avgLatencyMs Int?
  isActive     Boolean  @default(true)

  @@index([isActive])
  @@index([successCount, avgLatencyMs])
}

model NetworkAnalytics {
  id              String   @id @default(cuid())
  computedAt      DateTime @default(now())
  totalEvents     Int
  eventsByKind    Json
  hourlyEvents    Json
  dailyEvents     Json
  activeUsersHour Int
  activeUsersDay  Int
  activeUsersWeek Int
  totalZapSats    BigInt
  zapCount        Int
  avgZapSats      Int
  topZappedPosts  Json
  topHashtags     Json
  mediaPostCount  Int
  relayLatencyMs  Int
  eventsPerMinute Float

  @@index([computedAt])
}

model Feed {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  filterConfig  Json
  isPublic      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  subscriptions FeedSubscription[]

  @@index([userId, createdAt])
}

model FeedSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedId    String
  feed      Feed     @relation(fields: [feedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, feedId])
  @@index([feedId])
}

model Book {
  id           String    @id @default(uuid())
  authorPubkey String
  title        String
  description  String?
  coverUrl     String?
  status       String    @default("draft") // draft, published
  publishedAt  DateTime?
  nostrEventId String?
  totalZaps    BigInt    @default(0)
  buyerCount   Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  chapters Chapter[]

  @@index([authorPubkey, createdAt])
  @@index([status])
}

model Chapter {
  id         String   @id @default(uuid())
  bookId      String
  book        Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  title       String
  content     String   @db.Text
  orderIndex  Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([bookId, orderIndex])
  @@index([bookId, updatedAt])
}
